<div class="invoice-list-container">
  <div class="header-section">
    <h2 class="page-title">Invoices</h2>

    <div class="header-actions">
      <div class="search-box">
        <input class="invoice-search" placeholder="Search invoices..." [(ngModel)]="searchTerm"
          (ngModelChange)="applyFilter()" />
      </div>

      <div class="bulk-actions" *ngIf="selectedCount > 0">
        <button class="btn-pagination" *ngIf="selectedCount === 1" (click)="openPreview()">
          üëÅÔ∏è View
        </button>
        <button class="btn-pagination" *ngIf="selectedCount > 1" (click)="exportCsv()">
          üì• Export CSV
        </button>
      </div>
    </div>
  </div>

  <div class="table-container">
    <table class="invoice-table">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" (change)="toggleSelectAll($event)" /></th>
          <th>ID</th>
          <th>Client Name</th>
          <th>Phone number</th>
          <th>Total Amount</th>
          <th>Recived Amount</th>
          <th>Balance Amount</th>
          <th>Date</th>
          <th style="text-align: right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr class="invoice-row" *ngFor="let inv of paginatedInvoices; let i = index">
          <td>
            <input type="checkbox" [(ngModel)]="inv.selected" (change)="onSelectionChange()"
              (click)="$event.stopPropagation()" />
          </td>
          <td data-label="ID">{{ inv._id | slice:-5  }}</td>

          <td data-label="Client">
            <div class="client-info">
              <span class="client-name" *ngIf="editingInvoice?._id !== inv._id">{{ inv.userName }}</span>
              <input class="edit-input" *ngIf="editingInvoice?._id === inv._id" [(ngModel)]="editingInvoice.userName" />
            </div>
          </td>

          <td data-label="Phone">
            <div class="client-info">
             <span class="client-phone" *ngIf="editingInvoice?._id !== inv._id">{{ inv.phoneNumber }}</span>
              <input class="edit-input" *ngIf="editingInvoice?._id === inv._id" [(ngModel)]="editingInvoice.phoneNumber"
                style="margin-top: 4px;" />
            </div>
          </td>

          <td data-label="Total">
            <span class="amount-cell" *ngIf="editingInvoice?._id !== inv._id">‚Çπ {{ inv.totalAmount | number }}</span>
            <input class="edit-input" type="number" *ngIf="editingInvoice?._id === inv._id"
              [(ngModel)]="editingInvoice.totalAmount" />
          </td>
          <td data-label="Received">
            <span class="amount-cell" *ngIf="editingInvoice?._id !== inv._id">‚Çπ {{ inv.receivedAmount | number }}</span>
            <input class="edit-input  " type="number" *ngIf="editingInvoice?._id === inv._id"
              [(ngModel)]="editingInvoice.receivedAmount" />
          </td>    
          <td data-label="Balance">
            <span class="amount-cell" [style.color]="inv.balanceAmount > 0 ? 'var(--accent-amber)' : 'inherit'">
              ‚Çπ {{ inv.balanceAmount | number }}
            </span>
          </td>

          <td data-label="Date">
            <span class="date-cell">{{ inv.createdAt | date:'dd MMM yyyy' }}</span>
          </td>

          <td>
            <div class="action-buttons">
              <!-- Default Actions -->
              <button *ngIf="editingInvoice?._id !== inv._id" class="btn-action"
                (click)="editInvoice(inv); $event.stopPropagation()" title="Edit">
                ‚úèÔ∏è
              </button>
              <button *ngIf="editingInvoice?._id !== inv._id" class="btn-action danger"
                (click)="deleteInvoice(inv._id); $event.stopPropagation()" title="Delete">
                üóëÔ∏è
              </button>

              <!-- Edit Mode Actions -->
              <button *ngIf="editingInvoice?._id === inv._id" class="btn-action"
                (click)="saveEdit(); $event.stopPropagation()" title="Save">
                ‚úÖ
              </button>
              <button *ngIf="editingInvoice?._id === inv._id" class="btn-action danger"
                (click)="cancelEdit(); $event.stopPropagation()" title="Cancel">
                ‚ùå
              </button>
            </div>
          </td>
        <!-- <tr *ngFor="let inv of paginatedInvoices; let i = index">
          <td><input type="checkbox" [(ngModel)]="inv.selected" (change)="onSelectionChange()" /></td>
          <td>{{ inv._id | slice:-6 }}</td>
          <td>{{ inv.userName }}</td>
          <td>{{ inv.phoneNumber }}</td>
          <td>‚Çπ {{ inv.totalAmount }}</td>
          <td>‚Çπ {{ inv.receivedAmount }}</td>
          <td>‚Çπ {{ inv.balanceAmount }}</td>
          <td>{{ inv.createdAt | date:'dd MMM yyyy' }}</td>
        </tr> -->
      </tbody>
    </table>
        <div class="pagination" *ngIf="totalPages > 1">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
            Prev
        </button>

        <span>
            Page {{ currentPage }} of {{ totalPages }}
        </span>

        <button (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next
        </button>
    </div>
  </div>

  <div class="pagination-container" *ngIf="totalPages > 1">
    <button (click)="prevPage()" [disabled]="currentPage === 1" class="btn-pagination">
      Previous
    </button>
    <span class="page-info">
      {{ currentPage }} / {{ totalPages }}
    </span>
    <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn-pagination">
      Next
    </button>
  </div>
</div>

<!-- ================= PREVIEW MODAL ================= -->
<div class="modal-backdrop" *ngIf="showPreview">
  <div class="modal">
    <div class="modal-header">
      <h3>Invoice Preview</h3>
      <div class="modal-actions">
        <button class="btn-primary" (click)="downloadPdf()">Download PDF</button>
        <button class="btn-secondary" (click)="printInvoice()">Print</button>
        <button class="btn-outline" (click)="closePreview()">Close</button>
      </div>
    </div>
    <div id="invoice-pdf" class="invoice-pdf">
      <app-invoice-template [invoice]="selectedInvoice"></app-invoice-template>
    </div>
  </div>
</div>